--Запрос Q1: найти все расходы всех членов указанной семьи за заданный период.


SELECT p.Имя, p.Фамилия, t.Сумма, t.Дата_транзакции
FROM Транзакция t
JOIN Пользователь p ON t.ID_пользователя = p.ID_пользователя
WHERE t.Тип_транзакции = 'Расход'
AND p.ID_семьи = 1  -- например, для семьи 1 
AND t.Дата_транзакции BETWEEN  '2023-01-30' AND  '2024-01-24 ' 

Запрос Q2: найти всех пользователей, у которых сделано не менее десяти записей о расходах указанной категории..

SELECT p.Имя, p.Фамилия
FROM Транзакция t
JOIN Пользователь p ON t.ID_пользователя = p.ID_пользователя
WHERE t.Тип_транзакции = 'Расход'
 AND t.ID_категории = 1  -- пример для категории 1 
GROUP BY p.ID_пользователя
HAVING COUNT(t.ID_транзакции) >= 10;

Запрос Q3: рассчитать баланс расходов и доходов всех пользователей на заданный момент времени.

SELECT p.Имя, p.Фамилия,
       COALESCE(SUM(CASE WHEN t.Тип_транзакции = 'Доход' THEN t.Сумма ELSE 0 END), 0) AS Доходы,
       COALESCE(SUM(CASE WHEN t.Тип_транзакции = 'Расход' THEN t.Сумма ELSE 0 END), 0) AS Расходы,
       (COALESCE(SUM(CASE WHEN t.Тип_транзакции = 'Доход' THEN t.Сумма ELSE 0 END), 0) -
        COALESCE(SUM(CASE WHEN t.Тип_транзакции = 'Расход' THEN t.Сумма ELSE 0 END), 0)) AS Баланс
FROM Транзакция t
JOIN Пользователь p ON t.ID_пользователя = p.ID_пользователя
WHERE t.Дата_транзакции <= '2024-11-24'  
GROUP BY p.ID_пользователя;

--Запрос Q4: для каждой семьи найти пользователя, который за последний год потратил денег больше всех в семье, и пользователя, который за последний месяц принес денег больше всех в семье.
SELECT p.ID_семьи, p.Имя, p.Фамилия, SUM(t.Сумма) AS Общие_расходы
FROM Транзакция t
JOIN Пользователь p ON t.ID_пользователя = p.ID_пользователя
WHERE t.Тип_транзакции = 'Расход'
  AND t.Дата_транзакции >= DATE '2023-12-31' - INTERVAL '1 year'
GROUP BY p.ID_семьи, p.ID_пользователя
ORDER BY p.ID_семьи, SUM(t.Сумма) DESC;

SELECT p.ID_семьи, p.Имя, p.Фамилия, SUM(t.Сумма) AS Общие_доходы
FROM Транзакция t
JOIN Пользователь p ON t.ID_пользователя = p.ID_пользователя
WHERE t.Тип_транзакции = 'Доход'
  AND t.Дата_транзакции >= DATE '2023-03-31' - INTERVAL '1 month'
GROUP BY p.ID_семьи, p.ID_пользователя
ORDER BY p.ID_семьи, SUM(t.Сумма) DESC;
